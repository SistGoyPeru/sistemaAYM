{% extends 'base.html' %}
{% if facturas_vencidas or incidentes_criticos %}
    <div class="col-12 mb-3">
        {% if facturas_vencidas %}
        <div class="alert alert-danger d-flex align-items-center mb-2" role="alert">
            <i class="fa-solid fa-triangle-exclamation me-2"></i>
            <div>
                <strong>¡Atención!</strong> Hay {{ facturas_vencidas|length }} factura(s) vencida(s) de proveedores.
            </div>
        </div>
        {% endif %}
        {% if incidentes_criticos %}
        <div class="alert alert-warning d-flex align-items-center" role="alert">
            <i class="fa-solid fa-bolt me-2"></i>
            <div>
                <strong>Incidentes críticos:</strong> {{ incidentes_criticos|length }} reporte(s) reciente(s) de incidentes críticos.
            </div>
        </div>
        {% endif %}
    </div>
{% endif %}
{% block content %}
<div class="row mb-4">
    <div class="col-12 mb-4">
        <div class="card shadow-sm">
            <div class="card-body">
                <h4 class="mb-3"><i class="fa-solid fa-chart-pie me-2"></i> Dashboard de Proveedores</h4>
                <div class="row">
                    <div class="col-md-6">
                        <canvas id="chartEstados"></canvas>
                    </div>
                    <div class="col-md-6">
                        <canvas id="chartScorecard"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-bg-primary mb-3">
            <div class="card-body">
                <h5 class="card-title">Total Proveedores</h5>
                <p class="card-text display-6">{{ total }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-bg-success mb-3">
            <div class="card-body">
                <h5 class="card-title">Activos</h5>
                <p class="card-text display-6">{{ activos }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-bg-warning mb-3">
            <div class="card-body">
                <h5 class="card-title">En prueba</h5>
                <p class="card-text display-6">{{ en_prueba }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-bg-danger mb-3">
            <div class="card-body">
                <h5 class="card-title">Bloqueados</h5>
                <p class="card-text display-6">{{ bloqueados }}</p>
            </div>
        </div>
    </div>
</div>

<h1>Lista de Proveedores</h1>
<form method="get" class="row g-2 mb-3 align-items-end">
    <div class="col-md-4">
        <label class="form-label">Buscar</label>
        <input type="text" name="q" value="{{ q }}" class="form-control" placeholder="Razón social, ID fiscal, email...">
    </div>
    <div class="col-md-3">
        <label class="form-label">Estado</label>
        <select name="estado" class="form-select">
            <option value="">Todos</option>
            <option value="activo" {% if estado_sel == 'activo' %}selected{% endif %}>Activo</option>
            <option value="en_prueba" {% if estado_sel == 'en_prueba' %}selected{% endif %}>En prueba</option>
            <option value="bloqueado" {% if estado_sel == 'bloqueado' %}selected{% endif %}>Bloqueado</option>
        </select>
    </div>
    <div class="col-md-5 d-flex gap-2">
        <button type="submit" class="btn btn-outline-primary">Filtrar</button>
        <button type="submit" name="exportar" value="1" class="btn btn-success"><i class="fa-solid fa-file-excel me-1"></i> Exportar a Excel</button>
        <a href="{% url 'nuevo_proveedor' %}" class="btn btn-primary">Registrar nuevo proveedor</a>
    </div>
</form>
<div class="table-responsive">
<table class="table table-striped table-hover">
    <thead class="table-primary">
        <tr>
            <th>Razón Social</th>
            <th>Nombre Comercial</th>
            <th>ID Fiscal</th>
            <th>Categoría</th>
            <th>Teléfono</th>
            <th>Email</th>
            <th>Estado</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody>
    {% for proveedor in proveedores %}
    <tr>
        <td>{{ proveedor.razon_social }}</td>
        <td>{{ proveedor.nombre_comercial }}</td>
        <td>{{ proveedor.id_fiscal }}</td>
        <td>{{ proveedor.categoria }}</td>
        <td>{{ proveedor.telefono }}</td>
        <td>{{ proveedor.email }}</td>
        <td>{{ proveedor.get_estado_display }}</td>
        <td>
            <a href="{% url 'detalle_proveedor' proveedor.id %}" class="btn btn-sm btn-info text-white" title="Ver reporte"><i class="fa-solid fa-chart-line"></i></a>
            <a href="{% url 'editar_proveedor' proveedor.id %}" class="btn btn-sm btn-outline-primary ms-1">Editar</a>
            <a href="{% url 'eliminar_proveedor' proveedor.id %}" class="btn btn-sm btn-outline-danger ms-1">Eliminar</a>
        </td>
    </tr>
    {% endfor %}
    </tbody>
</table>
</div>
<a href="{% url 'nuevo_proveedor' %}" class="btn btn-primary">Registrar nuevo proveedor</a>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Gráfico de Estados
const ctxEstados = document.getElementById('chartEstados').getContext('2d');
const chartEstados = new Chart(ctxEstados, {
        type: 'doughnut',
        data: {
                labels: ['Activos', 'En prueba', 'Bloqueados'],
                datasets: [{
                        data: [{{ activos }}, {{ en_prueba }}, {{ bloqueados }}],
                        backgroundColor: ['#198754', '#ffc107', '#dc3545'],
                }]
        },
        options: {
                plugins: { legend: { position: 'bottom' } },
                cutout: '70%'
        }
});
// Gráfico Scorecard (promedios)
const ctxScorecard = document.getElementById('chartScorecard').getContext('2d');
fetch('{% url "lista_proveedores" %}?dashboard=1')
    .then(r => r.json())
    .then(data => {
        new Chart(ctxScorecard, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [
                    { label: 'Calidad', data: data.calidad, backgroundColor: '#0d6efd' },
                    { label: 'Puntualidad', data: data.puntualidad, backgroundColor: '#20c997' },
                    { label: 'Cumplimiento', data: data.cumplimiento, backgroundColor: '#ffc107' }
                ]
            },
            options: {
                plugins: { legend: { position: 'bottom' } },
                responsive: true,
                scales: { y: { min: 0, max: 10 } }
            }
        });
    });
</script>
{% endblock %}

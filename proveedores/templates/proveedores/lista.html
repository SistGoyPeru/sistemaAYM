{% extends 'base.html' %}
{% if facturas_vencidas or incidentes_criticos %}
    <div class="col-12 mb-3">
        {% if facturas_vencidas %}
        <div class="alert alert-danger d-flex align-items-center mb-2" role="alert">
            <i class="fa-solid fa-triangle-exclamation me-2"></i>
            <div>
                <strong>¡Atención!</strong> Hay {{ facturas_vencidas|length }} factura(s) vencida(s) de proveedores.
            </div>
        </div>
        {% endif %}
        {% if incidentes_criticos %}
        <div class="alert alert-warning d-flex align-items-center" role="alert">
            <i class="fa-solid fa-bolt me-2"></i>
            <div>
                <strong>Incidentes críticos:</strong> {{ incidentes_criticos|length }} reporte(s) reciente(s) de incidentes críticos.
            </div>
        </div>
        {% endif %}
    </div>
{% endif %}
{% block content %}

<h1>Lista de Proveedores</h1>
<form method="get" class="row g-2 mb-3 align-items-end">
    <div class="col-md-4">
        <label class="form-label">Buscar</label>
        <input type="text" name="q" value="{{ q }}" class="form-control" placeholder="Razón social, ID fiscal, email...">
    </div>
    <div class="col-md-3">
        <label class="form-label">Estado</label>
        <select name="estado" class="form-select">
            <option value="">Todos</option>
            <option value="activo" {% if estado_sel == 'activo' %}selected{% endif %}>Activo</option>
            <option value="en_prueba" {% if estado_sel == 'en_prueba' %}selected{% endif %}>En prueba</option>
            <option value="bloqueado" {% if estado_sel == 'bloqueado' %}selected{% endif %}>Bloqueado</option>
        </select>
    </div>
    <div class="col-md-5 d-flex gap-2">
        <button type="submit" class="btn btn-outline-primary">Filtrar</button>
        <button type="submit" name="exportar" value="1" class="btn btn-success"><i class="fa-solid fa-file-excel me-1"></i> Exportar a Excel</button>
        <a href="{% url 'nuevo_proveedor' %}" class="btn btn-primary">Registrar nuevo proveedor</a>
    </div>
</form>
<div class="table-responsive">
<table class="table table-striped table-hover">
    <thead class="table-primary align-middle">
        <tr>
            <th>Logo</th>
            <th>Razón Social</th>
            <th>Nombre Comercial</th>
            <th>ID Fiscal</th>
            <th>Categoría</th>
            <th>Teléfono</th>
            <th>Email</th>
            <th>Estado</th>
            <th>Rating</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody>
    {% for proveedor in proveedores %}
    <tr>
        <td>
            {% if proveedor.logo %}
                <img src="{{ proveedor.logo.url }}" alt="Logo" class="rounded-circle border" style="width:40px;height:40px;object-fit:cover;">
            {% else %}
                <span class="fa-solid fa-user-tie fa-2x text-secondary"></span>
            {% endif %}
        </td>
        <td class="fw-bold">{{ proveedor.razon_social }}</td>
        <td>{{ proveedor.nombre_comercial }}</td>
        <td>{{ proveedor.id_fiscal }}</td>
        <td>{{ proveedor.categoria }}</td>
        <td>{{ proveedor.telefono }}</td>
        <td>{{ proveedor.email }}</td>
        <td>
            <span class="badge 
                {% if proveedor.estado == 'activo' %}bg-success
                {% elif proveedor.estado == 'en_prueba' %}bg-warning text-dark
                {% elif proveedor.estado == 'bloqueado' %}bg-danger
                {% else %}bg-secondary{% endif %}">
                {{ proveedor.get_estado_display }}
            </span>
        </td>
        <td>
            {% if proveedor.rating %}
                <span title="{{ proveedor.rating }} de 5">
                {% for i in estrellas %}
                    {% if i <= proveedor.rating %}
                        <i class="fa-solid fa-star text-warning"></i>
                    {% else %}
                        <i class="fa-regular fa-star text-warning"></i>
                    {% endif %}
                {% endfor %}
                </span>
            {% else %}
                <span class="text-muted">Sin rating</span>
            {% endif %}
        </td>
        <td>
            <a href="{% url 'detalle_proveedor' proveedor.id %}" class="btn btn-sm btn-info text-white" title="Ver reporte"><i class="fa-solid fa-chart-line"></i></a>
            <a href="{% url 'editar_proveedor' proveedor.id %}" class="btn btn-sm btn-outline-primary ms-1">Editar</a>
            <a href="{% url 'eliminar_proveedor' proveedor.id %}" class="btn btn-sm btn-outline-danger ms-1">Eliminar</a>
        </td>
    </tr>
    {% endfor %}
    </tbody>
</table>
</div>
<a href="{% url 'nuevo_proveedor' %}" class="btn btn-primary">Registrar nuevo proveedor</a>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Gráfico de Estados
const ctxEstados = document.getElementById('chartEstados').getContext('2d');
const chartEstados = new Chart(ctxEstados, {
        type: 'doughnut',
        data: {
                labels: ['Activos', 'En prueba', 'Bloqueados'],
                datasets: [{
                        data: [{{ activos }}, {{ en_prueba }}, {{ bloqueados }}],
                        backgroundColor: ['#198754', '#ffc107', '#dc3545'],
                }]
        },
        options: {
                plugins: { legend: { position: 'bottom' } },
                cutout: '70%'
        }
});
// Gráfico Scorecard (promedios)
const ctxScorecard = document.getElementById('chartScorecard').getContext('2d');
fetch('{% url "lista_proveedores" %}?dashboard=1')
    .then(r => r.json())
    .then(data => {
        new Chart(ctxScorecard, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [
                    { label: 'Calidad', data: data.calidad, backgroundColor: '#0d6efd' },
                    { label: 'Puntualidad', data: data.puntualidad, backgroundColor: '#20c997' },
                    { label: 'Cumplimiento', data: data.cumplimiento, backgroundColor: '#ffc107' }
                ]
            },
            options: {
                plugins: { legend: { position: 'bottom' } },
                responsive: true,
                scales: { y: { min: 0, max: 10 } }
            }
        });
    });
</script>
{% endblock %}
